<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Monitoreo de Humedad üå±</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  margin: 0;
  font-family: 'Poppins', sans-serif;
  background: radial-gradient(circle at top left, #0a1f2a, #0d1417, #000);
  background-attachment: fixed;
  color: #e8f6ff;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
  overflow-y: auto;
  overflow-x: hidden;
  position: relative;
}

/* üå´Ô∏è Textura tipo niebla/puntos sutil */
body::before {
  content: "";
  position: fixed;
  inset: 0;
  background-image: radial-gradient(rgba(255,255,255,0.05) 1px, transparent 1px);
  background-size: 70px 70px;
  opacity: 0.25;
  z-index: 0;
}

/* ==================== EFECTO DE LLUVIA ==================== */
.rain {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  pointer-events: none;
  z-index: 1;
}

.drop {
  position: absolute;
  width: 1.5px;
  height: 25px;
  background: rgba(255, 255, 255, 0.4);
  border-radius: 50%;
  filter: blur(0.5px);
  opacity: 0.6;
  animation: rainFall linear infinite;
}

@keyframes rainFall {
  0% { transform: translateY(-10vh); opacity: 0.8; }
  100% { transform: translateY(110vh) translateX(2vw); opacity: 0; }
}

/* ==================== ENCABEZADO ==================== */
header {
  width: 100%;
  background: linear-gradient(90deg, #0055a5, #0088cc);
  color: white;
  text-align: center;
  padding: 15px 0;
  font-size: 1.4em;
  font-weight: 600;
  letter-spacing: 1px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.4);
  z-index: 2;
  position: sticky;
  top: 0;
}

/* ==================== DASHBOARD ==================== */
.dashboard {
  background: rgba(255, 255, 255, 0.07);
  backdrop-filter: blur(15px);
  border-radius: 20px;
  box-shadow: 0 0 20px rgba(0,0,0,0.4);
  padding: 25px;
  margin: 25px auto;
  width: 90%;
  max-width: 600px;
  text-align: center;
  z-index: 2;
  border: 1px solid rgba(255,255,255,0.15);
}

/* ==================== GOTA ==================== */
.gota {
  width: 120px;
  height: 150px;
  background: radial-gradient(circle at 30% 30%, #33cfff, #0077cc 60%, #004b80);
  border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
  margin: 0 auto 10px auto;
  position: relative;
  animation: float 2.5s ease-in-out infinite;
  transition: background 0.6s ease, box-shadow 0.4s ease;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  box-shadow: 0 0 30px rgba(0, 174, 255, 0.5), inset 0 0 18px rgba(255, 255, 255, 0.3);
}

.gota::before {
  content: "";
  position: absolute;
  top: 18%;
  left: 25%;
  width: 35%;
  height: 25%;
  background: rgba(255, 255, 255, 0.4);
  border-radius: 50%;
  filter: blur(3px);
}

.gota::after {
  content: "";
  position: absolute;
  bottom: 15%;
  right: 20%;
  width: 20%;
  height: 15%;
  background: rgba(255, 255, 255, 0.25);
  border-radius: 50%;
  filter: blur(2px);
}

.carita { font-size: 2em; margin-bottom: 5px; pointer-events: none; }
.humedad-texto { font-size: 1.5em; pointer-events: none; }

.comentario {
  margin-top: 10px;
  font-size: 1.1em;
  color: #a7f3ff;
  font-style: italic;
}

.fecha-ubicacion {
  font-size: 0.9em;
  margin-top: 8px;
  color: #ccc;
}

.actualizacion {
  font-size: 0.9em;
  color: #66d1ff;
  margin-top: 5px;
}

@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-12px); }
}

/* ==================== GRAFICO ==================== */
.grafico-contenedor {
  position: relative;
  width: 100%;
  max-width: 600px;
  height: 300px;
  margin: 30px auto 0 auto;
}

canvas {
  width: 100% !important;
  height: 100% !important;
}

@media (max-width: 600px) {
  header { font-size: 1.2em; }
  .gota { width: 100px; height: 130px; }
  .dashboard { padding: 20px; }
  .grafico-contenedor { height: 250px; }
}
</style>
</head>
<body>
<div class="rain" id="rain"></div>
<header>üåø Humedad de la planta en Tiempo Real üåßÔ∏è</header>

<div class="dashboard">
  <div id="gota" class="gota">
    <div id="carita" class="carita">üòä</div>
    <div id="humedad" class="humedad-texto">--%</div>
  </div>
  <div id="comentario" class="comentario">Analizando estado de la planta...</div>
  <div id="fecha-ubicacion" class="fecha-ubicacion">Cargando fecha y ubicaci√≥n...</div>
  <div id="ultima" class="actualizacion">√öltima actualizaci√≥n: --:--:--</div>

  <div class="grafico-contenedor">
    <canvas id="grafico"></canvas>
  </div>
</div>

<script>
const canal = 3122727;
const apiKey = "KT8Z4PBWOXA399H0";
let datosHumedad = [];
let tiempo = [];
const gota = document.getElementById('gota');
const carita = document.getElementById('carita');
const humedadTexto = document.getElementById('humedad');
const comentario = document.getElementById('comentario');
const fechaUbicacion = document.getElementById('fecha-ubicacion');
const ultima = document.getElementById('ultima');

// ======= EFECTO DE LLUVIA =======
const rainContainer = document.getElementById("rain");
const numDrops = 80;
for (let i = 0; i < numDrops; i++) {
  const drop = document.createElement("div");
  drop.classList.add("drop");
  drop.style.left = Math.random() * 100 + "vw";
  drop.style.animationDuration = (1 + Math.random() * 2) + "s";
  drop.style.animationDelay = Math.random() * 4 + "s";
  drop.style.height = 15 + Math.random() * 15 + "px";
  rainContainer.appendChild(drop);
}

// ======= GRAFICO =======
const graficoCanvas = document.getElementById('grafico').getContext('2d');
const gradiente = graficoCanvas.createLinearGradient(0, 0, 0, 300);
gradiente.addColorStop(0, "rgba(0,194,255,0.6)");
gradiente.addColorStop(1, "rgba(0,194,255,0.1)");

const grafico = new Chart(graficoCanvas, {
  type: 'line',
  data: {
    labels: [],
    datasets: [{
      label: 'Historial de Humedad (%)',
      data: [],
      borderWidth: 3,
      borderColor: '#00baff',
      backgroundColor: gradiente,
      tension: 0.35,
      fill: true,
      pointRadius: 4
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    scales: { 
      y: { beginAtZero: true, max: 100, grid: { color: "rgba(255,255,255,0.08)" } },
      x: { grid: { color: "rgba(255,255,255,0.08)" } }
    },
    plugins: { legend: { labels: { color: "#a7f3ff" } } }
  }
});

// ======= FUNCIONES =======
async function obtenerHumedad() {
  try {
    const res = await fetch(`https://api.thingspeak.com/channels/${canal}/fields/4.json?results=10&api_key=${apiKey}`);
    const data = await res.json();
    const feeds = data.feeds;
    if (feeds.length > 0) {
      datosHumedad = feeds.map(f => parseFloat(f[`field4`]));
      tiempo = feeds.map(f => new Date(f.created_at).toLocaleTimeString());
      const ultimaH = datosHumedad[datosHumedad.length - 1];
      actualizarGota(ultimaH);
      actualizarGrafico();
      ultima.textContent = "√öltima actualizaci√≥n: " + new Date().toLocaleTimeString();
    }
  } catch (e) { console.error("Error al leer datos", e); }
}

function actualizarGota(h) {
  humedadTexto.textContent = `${h.toFixed(1)}%`;
  if (h > 80) {
    gota.style.background = "linear-gradient(135deg, #007bff, #0044cc)";
    carita.textContent = "üòÖ";
    comentario.textContent = "Demasiada humedad. Evita regar la planta.";
  } else if (h > 50) {
    gota.style.background = "linear-gradient(135deg, #00baff, #0077cc)";
    carita.textContent = "üòä";
    comentario.textContent = "La planta est√° bien hidratada üåø";
  } else if (h > 30) {
    gota.style.background = "linear-gradient(135deg, #ffaa00, #ff8800)";
    carita.textContent = "üòê";
    comentario.textContent = "Comienza a necesitar agua üíß";
  } else {
    gota.style.background = "linear-gradient(135deg, #ff4444, #cc0000)";
    carita.textContent = "ü•µ";
    comentario.textContent = "¬°La planta est√° muy seca! Ri√©gala pronto üöø";
  }
}

function actualizarGrafico() {
  grafico.data.labels = tiempo;
  grafico.data.datasets[0].data = datosHumedad;
  grafico.update();
}

function actualizarFechaUbicacion() {
  const fecha = new Date().toLocaleString();
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude.toFixed(4);
      const lon = pos.coords.longitude.toFixed(4);
      fechaUbicacion.textContent = `Fecha: ${fecha} | Lat: ${lat}, Lon: ${lon}`;
    }, () => {
      fechaUbicacion.textContent = `Fecha: ${fecha} | Ubicaci√≥n no disponible`;
    });
  } else {
    fechaUbicacion.textContent = `Fecha: ${fecha} | Ubicaci√≥n no disponible`;
  }
}

obtenerHumedad();
actualizarFechaUbicacion();
setInterval(() => {
  obtenerHumedad();
  actualizarFechaUbicacion();
}, 10000);
</script>
</body>
</html>
