<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>🌿 Mi Plantita Habladora 🌧️</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  margin: 0;
  font-family: 'Poppins', sans-serif;
  background: radial-gradient(circle at top left, #0a1f2a, #0d1417, #000);
  background-attachment: fixed;
  color: #e8f6ff;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
  overflow-y: auto;
}
body::before {
  content: "";
  position: fixed;
  inset: 0;
  background-image: radial-gradient(rgba(255,255,255,0.05) 1px, transparent 1px);
  background-size: 70px 70px;
  opacity: 0.25;
  z-index: 0;
}
header {
  width: 100%;
  background: linear-gradient(90deg, #00baff, #0077cc);
  color: white;
  text-align: center;
  padding: 15px 0;
  font-size: 1.4em;
  font-weight: 600;
  position: sticky;
  top: 0;
}
.menu {
  display: flex;
  gap: 15px;
  margin-top: 15px;
  z-index: 2;
}
.boton {
  background: linear-gradient(135deg, #0099ff, #0066cc);
  border: none;
  border-radius: 12px;
  color: white;
  padding: 10px 20px;
  font-size: 1em;
  cursor: pointer;
  transition: 0.3s;
  box-shadow: 0 0 10px rgba(0,153,255,0.3);
}
.boton:hover {
  background: linear-gradient(135deg, #00ccff, #0088ff);
  transform: scale(1.05);
}
.dashboard {
  background: rgba(255,255,255,0.07);
  backdrop-filter: blur(15px);
  border-radius: 20px;
  box-shadow: 0 0 20px rgba(0,0,0,0.4);
  padding: 25px;
  margin: 25px auto;
  width: 90%;
  max-width: 600px;
  text-align: center;
  z-index: 2;
  border: 1px solid rgba(255,255,255,0.15);
}
.gota {
  width: 120px;
  height: 150px;
  background: radial-gradient(circle at 30% 30%, #33cfff, #0077cc 60%, #004b80);
  border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
  margin: 0 auto 10px auto;
  position: relative;
  animation: float 2.5s ease-in-out infinite;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  box-shadow: 0 0 30px rgba(0,174,255,0.5), inset 0 0 18px rgba(255,255,255,0.3);
}
.carita { font-size: 2.2em; margin-bottom: 5px; }
.humedad-texto { font-size: 1.5em; }
.comentario {
  margin-top: 10px;
  font-size: 1.1em;
  color: #a7f3ff;
  font-style: italic;
}
.info {
  margin-top: 15px;
  font-size: 0.95em;
  color: #9edaff;
  text-shadow: 0 0 3px rgba(0,255,255,0.4);
}
@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-12px); }
}
.grafico-contenedor {
  display: none;
  width: 100%;
  max-width: 600px;
  height: 300px;
  margin: 30px auto 0 auto;
}
canvas { width: 100% !important; height: 100% !important; }
</style>
</head>
<body>
<header>🌱 ¡Hola! Soy tu plantita 🌧️</header>

<div class="menu">
  <button class="boton" onclick="activarPlanta()">🌿 Ver mi estado</button>
  <button class="boton" onclick="mostrarGrafico()">📈 Ver mi historia</button>
</div>

<div class="dashboard">
  <div id="gota" class="gota">
    <div id="carita" class="carita">😊</div>
    <div id="humedad" class="humedad-texto">--%</div>
  </div>

  <div id="comentario" class="comentario">Presiona "Ver mi estado" para comenzar</div>

  <div class="info" id="info">
    📍 <span id="ubicacion">Ubicación no detectada</span><br>
    ⏰ <span id="fecha">--/--/----</span> — <span id="hora">--:--:--</span>
  </div>

  <div class="grafico-contenedor" id="grafico-contenedor">
    <canvas id="grafico"></canvas>
  </div>
</div>

<script>
const canal = 3122727;
const apiKey = "KT8Z4PBWOXA399H0";

let datosHumedad = [], tiempo = [];
let vozListas = false;
let ubicacionDetectada = false;

// Elementos
const gota = document.getElementById('gota');
const carita = document.getElementById('carita');
const humedadTexto = document.getElementById('humedad');
const comentario = document.getElementById('comentario');
const ubicacionTexto = document.getElementById('ubicacion');
const fechaTexto = document.getElementById('fecha');
const horaTexto = document.getElementById('hora');
const graficoContenedor = document.getElementById('grafico-contenedor');

// Inicializa gráfico
const ctx = document.getElementById('grafico').getContext('2d');
const grad = ctx.createLinearGradient(0, 0, 0, 300);
grad.addColorStop(0, "rgba(0,194,255,0.6)");
grad.addColorStop(1, "rgba(0,194,255,0.1)");
const grafico = new Chart(ctx, {
  type: 'line',
  data: { labels: [], datasets: [{ label: 'Humedad (%)', data: [], borderWidth: 3, borderColor: '#00baff', backgroundColor: grad, tension: 0.35, fill: true }]},
  options: { scales: { y: { beginAtZero: true, max: 100 } } }
});

// Función principal
async function activarPlanta() {
  inicializarVoz();
  pedirUbicacion();
  await obtenerHumedad();
}

// Voz
function inicializarVoz() {
  if ('speechSynthesis' in window) {
    speechSynthesis.getVoices();
    vozListas = true;
  }
}
function hablar(texto) {
  if (!vozListas) return;
  const voz = new SpeechSynthesisUtterance(texto);
  voz.lang = 'es-ES';
  speechSynthesis.cancel();
  speechSynthesis.speak(voz);
}

// Fecha/Hora
function actualizarFechaHora() {
  const ahora = new Date();
  fechaTexto.textContent = ahora.toLocaleDateString();
  horaTexto.textContent = ahora.toLocaleTimeString();
}

// Ubicación (solo tras clic)
function pedirUbicacion() {
  if (!navigator.geolocation) {
    ubicacionTexto.textContent = "Geolocalización no soportada";
    return;
  }
  navigator.geolocation.getCurrentPosition(async pos => {
    const { latitude, longitude } = pos.coords;
    try {
      const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json`);
      const data = await res.json();
      ubicacionTexto.textContent = data.address.city
        ? `${data.address.city}, ${data.address.country}`
        : `${data.display_name}`;
      ubicacionDetectada = true;
    } catch {
      ubicacionTexto.textContent = "No se pudo obtener la ubicación.";
    }
  }, err => {
    ubicacionTexto.textContent = "Permiso de ubicación denegado.";
  });
}

// Obtener datos
async function obtenerHumedad() {
  try {
    const res = await fetch(`https://api.thingspeak.com/channels/3122727/fields/4.json?results=10&api_key=KT8Z4PBWOXA399H0`);
    const data = await res.json();
    const feeds = data.feeds;
    if (feeds.length > 0) {
      datosHumedad = feeds.map(f => parseFloat(f.field4));
      tiempo = feeds.map(f => new Date(f.created_at).toLocaleTimeString());
      const ultimaH = datosHumedad[datosHumedad.length - 1];
      actualizarGota(ultimaH);
      grafico.data.labels = tiempo;
      grafico.data.datasets[0].data = datosHumedad;
      grafico.update();
      actualizarFechaHora();
    }
  } catch {
    comentario.textContent = "Error al leer datos de la planta.";
  }
}

// Reacciones
function actualizarGota(h) {
  humedadTexto.textContent = `${h.toFixed(0)}%`;
  if (h > 80) {
    gota.style.background = "linear-gradient(135deg, #007bff, #0044cc)";
    carita.textContent = "😅";
    comentario.textContent = "🌧 ¡Tengo demasiada agua!";
    hablar("Tengo demasiada agua, no me pongas más.");
  } else if (h > 50) {
    gota.style.background = "linear-gradient(135deg, #00baff, #0077cc)";
    carita.textContent = "😊";
    comentario.textContent = "🌿 ¡Estoy feliz y fresquita!";
    hablar("Estoy bien de humedad, gracias.");
  } else if (h > 30) {
    gota.style.background = "linear-gradient(135deg, #ffaa00, #ff8800)";
    carita.textContent = "😐";
    comentario.textContent = "💧 Tengo sed...";
    hablar("Tengo un poquito de sed, podrías regarme pronto.");
  } else {
    gota.style.background = "linear-gradient(135deg, #ff4444, #cc0000)";
    carita.textContent = "🥵";
    comentario.textContent = "😢 ¡Dame agüita ya!";
    hablar("Estoy muy seca, por favor dame agüita ya.");
  }
}

// Mostrar gráfico
function mostrarGrafico() {
  graficoContenedor.style.display = graficoContenedor.style.display === "none" ? "block" : "none";
}
</script>
</body>
</html>
