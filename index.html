<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Monitoreo de Humedad üå±</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  margin:0;
  font-family:'Poppins',sans-serif;
  color:#e8f6ff;
  display:flex;
  flex-direction:column;
  align-items:center;
  min-height:100vh;
  overflow:hidden;
  position:relative;
  transition: background 1s ease;
}
body::before {
  content:"";
  position:fixed;
  inset:0;
  background-image:radial-gradient(rgba(255,255,255,0.05) 1px, transparent 1px);
  background-size:70px 70px;
  opacity:0.25;
  z-index:0;
}
/* --- Lluvia --- */
.rain{position:fixed;top:0;left:0;width:100%;height:100%;overflow:hidden;pointer-events:none;z-index:1;}
.drop{position:absolute;width:1.5px;height:25px;background:rgba(255,255,255,0.4);border-radius:50%;filter:blur(0.5px);opacity:0.6;animation:rainFall linear infinite;}
@keyframes rainFall{0%{transform:translateY(-10vh);opacity:0.8;}100%{transform:translateY(110vh) translateX(2vw);opacity:0;}}

/* --- Nubes --- */
.clouds {position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;overflow:hidden;z-index:0;}
.cloud {position:absolute;display:flex;flex-direction:row;align-items:flex-end;pointer-events:none;}
.cloud div {background: linear-gradient(to bottom, rgba(255,255,255,0.9), rgba(255,255,255,0.6)); border-radius:50%; margin-left:-20px; filter: blur(6px);}

/* --- Header y men√∫ --- */
header{width:100%;background:linear-gradient(90deg,#0055a5,#0088cc);color:white;text-align:center;padding:15px 0;font-size:1.4em;font-weight:600;letter-spacing:1px;box-shadow:0 2px 8px rgba(0,0,0,0.4);z-index:2;position:sticky;top:0;}
nav{display:flex;justify-content:center;margin-top:15px;gap:15px;z-index:2;}
nav button{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.25);color:#a7f3ff;padding:10px 20px;border-radius:12px;font-size:1em;cursor:pointer;transition:all 0.3s ease;}
nav button.active{background:linear-gradient(90deg,#00baff,#0077cc);color:white;box-shadow:0 0 10px rgba(0,174,255,0.6);}

/* --- Secciones --- */
section{display:none;animation:fadeIn 0.6s ease forwards;width:90%;max-width:600px;margin-top:20px;z-index:2;}
section.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}

/* --- Dashboard y gota --- */
.dashboard{background:rgba(255,255,255,0.07);backdrop-filter:blur(15px);border-radius:20px;box-shadow:0 0 20px rgba(0,0,0,0.4);padding:25px;text-align:center;border:1px solid rgba(255,255,255,0.15);}
.gota{width:180px;height:220px;background:radial-gradient(circle at 30% 30%,#33cfff,#0077cc 60%,#004b80);border-radius:50% 50% 50% 50%/60% 60% 40% 40%;margin:40px auto;position:relative;animation:float 2.5s ease-in-out infinite;display:flex;flex-direction:column;align-items:center;justify-content:center;color:white;font-weight:bold;box-shadow:0 0 40px rgba(0,174,255,0.5), inset 0 0 18px rgba(255,255,255,0.3);}
@keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-15px);}}
.gota::before{content:"";position:absolute;top:18%;left:25%;width:35%;height:25%;background:rgba(255,255,255,0.4);border-radius:50%;filter:blur(3px);}
.gota::after{content:"";position:absolute;bottom:15%;right:20%;width:20%;height:15%;background:rgba(255,255,255,0.25);border-radius:50%;filter:blur(2px);}
.carita{font-size:2.5em;margin-bottom:5px;}
.humedad-texto{font-size:2em;}
.comentario{margin-top:10px;font-size:1.2em;color:#a7f3ff;font-style:inherit;}
.fecha-ubicacion,.ultima{position:fixed;font-size:0.9em;z-index:3;padding:5px 10px;background:rgba(20,20,20,0.15);border-radius:8px;}
.fecha-ubicacion{bottom:10px;left:10px;}
.ultima{bottom:10px;right:10px;color:#fafafa;}
.grafico-contenedor{position:relative;width:100%;height:300px;margin-top:25px;}
canvas{width:100%!important;height:100%!important;}

/* --- Ajustes m√≥viles --- */
@media (max-width:600px){
    header{font-size:1.2em;}
    .gota{width:150px;height:180px;}
    .carita{font-size:2em;}
    .humedad-texto{font-size:1.5em;}
    nav button{padding:8px 16px;font-size:0.9em;}
}
</style>
</head>
<body>
<div class="rain" id="rain"></div>
<div class="clouds" id="clouds"></div>

<header>üåø Monitoreo de Humedad üåßÔ∏è</header>
<nav>
  <button id="btnEstado" class="active">Ver Estado</button>
  <button id="btnGraficas">Ver Gr√°ficas</button>
</nav>

<section id="estado" class="active">
  <div class="dashboard">
    <div id="gota" class="gota">
      <div id="carita" class="carita">üòä</div>
      <div id="humedad" class="humedad-texto">--%</div>
    </div>
    <div id="comentario" class="comentario">Analizando estado de la planta...</div>
  </div>
</section>

<section id="graficas">
  <div class="dashboard">
    <div class="grafico-contenedor">
      <canvas id="grafico"></canvas>
    </div>
  </div>
</section>

<div id="fecha-ubicacion" class="fecha-ubicacion">Cargando fecha y ubicaci√≥n...</div>
<div id="ultima" class="ultima">√öltima actualizaci√≥n: --:--:--</div>

<script>
// --- Configuraci√≥n ---
const canal = 3122727;
const apiKey = "KT8Z4PBWOXA399H0";
let datosHumedad=[], tiempo=[];
const gota = document.getElementById('gota');
const carita = document.getElementById('carita');
const humedadTexto = document.getElementById('humedad');
const comentario = document.getElementById('comentario');
const fechaUbicacion = document.getElementById('fecha-ubicacion');
const ultima = document.getElementById('ultima');
const rainContainer = document.getElementById("rain");
const cloudsContainer = document.getElementById("clouds");

let estadoTexto="";
let ultimaHumedadHablada=null;
let speechEnabled=false;

// --- Lluvia ---
function crearLluvia(cantidad){
    rainContainer.innerHTML="";
    for(let i=0;i<cantidad;i++){
        const drop=document.createElement("div");
        drop.classList.add("drop");
        drop.style.left=Math.random()*100+"vw";
        drop.style.animationDuration=(1+Math.random()*2)+"s";
        drop.style.animationDelay=Math.random()*4+"s";
        drop.style.height=15+Math.random()*15+"px";
        rainContainer.appendChild(drop);
    }
}

// --- Nubes sin salto ---
let nubes=[];
function crearNube(capa, xInicial){
    const cloud = document.createElement("div");
    cloud.classList.add("cloud");
    cloud.style.top = Math.random()*40 + "vh";
    cloud.style.opacity = capa.opacidad;
    cloud.style.transform = `scale(${capa.escala})`;
    cloud.style.left = xInicial + "px";

    const partes = 3 + Math.floor(Math.random()*3);
    for(let j=0;j<partes;j++){
        const puff=document.createElement("div");
        let w=60+Math.random()*80;
        let h=w/2;
        puff.style.width=w+"px";
        puff.style.height=h+"px";
        cloud.appendChild(puff);
    }

    cloudsContainer.appendChild(cloud);
    const cloudDup = cloud.cloneNode(true);
    cloudsContainer.appendChild(cloudDup);
    nubes.push({el:cloud, dup:cloudDup, velocidad:capa.velocidad});
}

function crearNubesContinuas(){
    cloudsContainer.innerHTML="";
    nubes=[];
    const isMobile = window.innerWidth <= 600;
    const capas=[
        {cantidad:isMobile?2:3, velocidad:isMobile?0.07:0.12, opacidad:0.6, escala:isMobile?0.8:1},
        {cantidad:isMobile?2:4, velocidad:isMobile?0.05:0.09, opacidad:0.8, escala:isMobile?1:1.2},
        {cantidad:isMobile?1:3, velocidad:isMobile?0.03:0.06, opacidad:1, escala:isMobile?1.2:1.5}
    ];
    capas.forEach(capa=>{
        for(let i=0;i<capa.cantidad;i++){
            crearNube(capa, Math.random()*window.innerWidth*2 - window.innerWidth);
        }
    });
}

function moverNubes(){
    nubes.forEach(n=>{
        let x=parseFloat(n.el.style.left);
        let xDup=parseFloat(n.dup.style.left);
        x += n.velocidad*2;
        xDup += n.velocidad*2;
        const width = n.el.offsetWidth;
        if(x > window.innerWidth) x = xDup - width;
        if(xDup > window.innerWidth) xDup = x - width;
        n.el.style.left = x+"px";
        n.dup.style.left = xDup+"px";
    });
    requestAnimationFrame(moverNubes);
}

// --- Configurar gr√°fico ---
const ctx=document.getElementById('grafico').getContext('2d');
const gradiente=ctx.createLinearGradient(0,0,0,300);
gradiente.addColorStop(0,"rgba(0,194,255,0.6)");
gradiente.addColorStop(1,"rgba(0,194,255,0.1)");
const grafico=new Chart(ctx,{
  type:'line',
  data:{labels:[],datasets:[{label:'Historial de Humedad (%)',data:[],borderWidth:3,borderColor:'#00baff',backgroundColor:gradiente,tension:0.35,fill:true,pointRadius:4}]},
  options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,max:100,grid:{color:"rgba(255,255,255,0.08)"}},x:{grid:{color:"rgba(255,255,255,0.08)"}}},plugins:{legend:{labels:{color:"#a7f3ff"}}}}
});

// --- Fondo ---
function actualizarFondo(){
    const hora=new Date().getHours();
    const isMobile = window.innerWidth <= 600;
    if(hora>=6 && hora<18){
        document.body.style.background="radial-gradient(circle at top left, #87CEFA, #4682B4, #0a1f2a)";
        rainContainer.style.display="none";
        cloudsContainer.style.display="block";
        crearNubesContinuas();
        moverNubes();
        crearLluvia(0);
    } else {
        document.body.style.background="radial-gradient(circle at top left, #0a1f2a, #0d1417, #000)";
        cloudsContainer.style.display="none";
        rainContainer.style.display="block";
        crearLluvia(isMobile?30:80);
    }
}

// --- Hablar solo si cambia humedad ---
function hablarEstadoSiCambioSignificativo(h,texto){
    if(!speechEnabled) return;
    if(ultimaHumedadHablada===null||Math.abs(h-ultimaHumedadHablada)>=5){
        if('speechSynthesis' in window){
            speechSynthesis.cancel();
            const msg=new SpeechSynthesisUtterance(texto);
            msg.lang='es-ES';
            msg.rate=1;
            msg.pitch=1;
            speechSynthesis.speak(msg);
            ultimaHumedadHablada=h;
        }
    }
}

// --- Actualizar gota ---
function actualizarGota(h){
    humedadTexto.textContent=`${h.toFixed(1)}%`;
    if(h>80){gota.style.background="linear-gradient(135deg, #007bff, #0044cc)";carita.textContent="üòÖ";comentario.textContent="Demasiada humedad. Evita regar la planta.";estadoTexto="Demasiada humedad. Evita regar la planta.";}
    else if(h>50){gota.style.background="linear-gradient(135deg, #00baff, #0077cc)";carita.textContent="üòä";comentario.textContent="La planta est√° normal de agua.";estadoTexto="La planta est√° bien";}
    else if(h>30){gota.style.background="linear-gradient(135deg, #ffaa00, #ff8800)";carita.textContent="üòê";comentario.textContent="Comienza a necesitar agua.";estadoTexto="Comienza a necesitar agua";}
    else{gota.style.background="linear-gradient(135deg, #ff4444, #cc0000)";carita.textContent="ü•µ";comentario.textContent="¬°La planta est√° muy seca! Ri√©gala pronto.";estadoTexto="La planta est√° muy seca. Ri√©gala pronto";}
    hablarEstadoSiCambioSignificativo(h,estadoTexto);
}

// --- Actualizar gr√°fico ---
function actualizarGrafico(){grafico.data.labels=tiempo;grafico.data.datasets[0].data=datosHumedad;grafico.update();}

// --- Obtener humedad ---
async function obtenerHumedad(){
    try{
        const res=await fetch(`https://api.thingspeak.com/channels/${canal}/fields/4.json?results=10&api_key=${apiKey}`);
        const data=await res.json();
        const feeds=data.feeds;
        if(feeds.length>0){
            datosHumedad=feeds.map(f=>parseFloat(f.field4));
            tiempo=feeds.map(f=>new Date(f.created_at).toLocaleTimeString());
            const ultimaH=datosHumedad[datosHumedad.length-1];
            actualizarGota(ultimaH);
            actualizarGrafico();
            ultima.textContent="√öltima actualizaci√≥n: "+new Date(feeds[feeds.length-1].created_at).toLocaleString();
        }
    }catch(e){console.error("Error al leer datos",e);}
}

// --- Fecha y ubicaci√≥n ---
function actualizarFechaUbicacion(){
    const fecha=new Date().toLocaleString();
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
            const lat=pos.coords.latitude.toFixed(4);
            const lon=pos.coords.longitude.toFixed(4);
            fechaUbicacion.textContent=`Fecha: ${fecha} | Lat: ${lat}, Lon: ${lon}`;
        },()=>{fechaUbicacion.textContent=`Fecha: ${fecha} | Ubicaci√≥n no disponible`;});
    } else fechaUbicacion.textContent=`Fecha: ${fecha} | Ubicaci√≥n no disponible`;
}

// --- Men√∫ ---
const btnEstado=document.getElementById('btnEstado');
const btnGraficas=document.getElementById('btnGraficas');
const secEstado=document.getElementById('estado');
const secGraficas=document.getElementById('graficas');
btnEstado.onclick=()=>{btnEstado.classList.add('active');btnGraficas.classList.remove('active');secEstado.classList.add('active');secGraficas.classList.remove('active');};
btnGraficas.onclick=()=>{btnGraficas.classList.add('active');btnEstado.classList.remove('active');secGraficas.classList.add('active');secEstado.classList.remove('active');};

// --- Inicializaci√≥n ---
actualizarFondo();
obtenerHumedad();
actualizarFechaUbicacion();

// --- Repetici√≥n cada 10 segundos ---
setInterval(()=>{actualizarFondo();obtenerHumedad();actualizarFechaUbicacion();},10000);

// --- Repetici√≥n cada 1 minuto para hablar si cambia ---
setInterval(()=>{
    if(datosHumedad.length>0){
        const ultimaH=datosHumedad[datosHumedad.length-1];
        actualizarGota(ultimaH);
    }
},60000);

// --- Activar s√≠ntesis de voz en iOS tras primer toque ---
function enableSpeechOnInteraction(){
    if(!speechEnabled && 'speechSynthesis' in window){
        speechEnabled = true;
        window.removeEventListener('click', enableSpeechOnInteraction);
    }
}
window.addEventListener('click', enableSpeechOnInteraction);
</script>
</body>
</html>
